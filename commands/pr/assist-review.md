---
description: Pull Requestを理解しやすくするための支援ツールです。PRの構造を図式化し、変更点やレビュー観点を整理します。PRレビュー前の準備、PRの理解、レビュー観点の整理に関する要求でトリガーされます。
arguments:
  - name: pr-url
    description: レビューしたいPull RequestのURL
    required: false
    default: ""
    argument-hint: "PR URLを入力してください。形式: https://github.com/{owner}/{repo}/pull/{number}"
allowed-tools:
  - Bash(gh:*)
  - Read
  - Write
  - Grep
---

# PR Review支援

## ステップ1：PR URLの取得

ユーザーからPRのURLを取得してください。ユーザーがコマンド実行時にURLを提供するか、メッセージ内にURLが含まれている場合は、それを抽出してください。

**URLが提供されていない場合のメッセージ：**

```text
PR Review Assistantを使用して、Pull Requestを理解しやすく整理します。

レビューしたいPull RequestのURLを入力してください。
URLの形式：https://github.com/{owner}/{repo}/pull/{number}
```

GitHub PR URLの形式：`https://github.com/{owner}/{repo}/pull/{number}`

URLから`owner`、`repo`、`pr_number`を抽出します。

## ステップ2：PR情報の収集

GitHub APIを使用してPRの詳細情報を取得します：

```bash
# PR基本情報を取得
gh api repos/$OWNER/$REPO/pulls/$PR_NUMBER --jq '{
  title,
  body,
  state,
  author: .user.login,
  created_at,
  updated_at,
  base: .base.ref,
  head: .head.ref,
  mergeable,
  mergeable_state,
  draft,
  review_comments,
  comments,
  commits
}'

# PR内の変更ファイル一覧を取得
gh api repos/$OWNER/$REPO/pulls/$PR_NUMBER/files --jq '.[] | {
  filename: .filename,
  status: .status,
  additions: .additions,
  deletions: .deletions,
  changes: .changes
}'

# PRのコミット履歴を取得
gh api repos/$OWNER/$REPO/pulls/$PR_NUMBER/commits --jq '.[] | {
  sha: .sha,
  message: .commit.message,
  author: .commit.author.name,
  date: .commit.author.date
}'
```

## ステップ3：PR構造の図式化

PRの構造をMermaid図式で可視化します。以下を図示してください：
- ファイル構造：変更されたファイルの階層構造
- 変更の流れ：コミット履歴に基づく変更の流れ
- ファイル依存関係：変更されたファイル間の依存関係（可能な場合）

## ステップ4：コードの読み込みと分析

GitHub APIで取得したdiff情報と、必要に応じてファイルの内容を読み込み、UML図やフロー図を作成するための分析を行います。

変更されたファイルの内容を分析し、以下を確認します：

### クラス構造の分析
- クラス・構造体・インターフェースの定義
- クラス間の継承・実装関係
- クラスの属性（プロパティ、フィールド）
- クラスの操作（メソッド、関数）
- クラス間の関連（依存、集約、コンポジション）

### 関数・メソッドの分析
- 関数・メソッドの呼び出し関係
- 関数のシグネチャ（引数、戻り値）
- 関数の責務と目的

### データフローの分析
- データの受け渡し
- データの変換・加工
- データの保存・取得

### 処理フローの分析
- API呼び出しの順序
- 条件分岐とループ
- エラーハンドリングの流れ
- 非同期処理の流れ

### 状態遷移の分析
- 状態の定義
- 状態間の遷移条件
- 状態遷移時の処理

## ステップ5：UML図とフロー図の作成

変更されたコードから、適切なUML図とフロー図をMermaid記法で作成します。

### 作成する図の種類（PRの内容に応じて選択）
- **クラス図**：クラス・構造体の関係性
- **シーケンス図**：処理の流れ、API呼び出しの順序
- **フローチャート**：条件分岐、処理フロー
- **状態遷移図**：状態の変化

## ステップ6：修正前後の挙動比較表の作成

PRの説明文、コミットメッセージ、コードの変更内容（diff）から、各機能や修正点における「修正前（Before）」と「修正後（After）」の挙動の違いを分析し、表形式で整理します。

| 機能/修正項目 | 修正前 (Before) | 修正後 (After) | 備考 |
| :--- | :--- | :--- | :--- |
| {項目名} | {修正前の挙動・状態} | {修正後の挙動・状態} | {関連する変更ファイルや補足} |

## ステップ7：レビュー観点の整理

PRの内容に基づいて、レビューすべき観点をカテゴリ別に整理します。

### レビュー観点のカテゴリ

1. **機能性**：要件の実装、エッジケース、エラーハンドリング
2. **コード品質**：可読性、命名規則、コードの重複
3. **アーキテクチャ**：設計パターン、関心の分離、依存関係
4. **パフォーマンス**：パフォーマンスへの影響、メモリ使用量
5. **セキュリティ**：セキュリティ脆弱性、認証・認可
6. **テスト**：テストカバレッジ、テストの品質
7. **ドキュメント**：コメント、README、APIドキュメント
8. **UI/UX**：UIの一貫性、アクセシビリティ、ユーザー体験

### レビュー優先度の設定

- **高優先度**：セキュリティ関連、重大なバグ、パフォーマンスへの大きな影響
- **中優先度**：コード品質、アーキテクチャ、テスト
- **低優先度**：ドキュメント、UI/UXの微調整

## ステップ8：調査結果の整理と出力

PRの調査結果を整理し、Markdownファイルとして出力します。

### 出力手順

1. **ファイル名の決定**: `PR_Review_{pr_number}.md`
2. **ファイルパスの決定**: ワークスペースのルートディレクトリに保存
3. **Markdownコンテンツの作成**: テンプレートに従って調査結果を含むMarkdownコンテンツを作成
4. **ファイルの保存**: `Write` ツールを使用して、Markdownコンテンツをファイルに書き込み
5. **出力確認**: ファイルが正常に作成されたことを確認し、ユーザーに通知

### 出力テンプレート

以下の形式でコンテンツを作成し、ファイルに書き出します。**目的→全体像→懸念点→詳細**の順に、段階的に情報を提供します：

```markdown
# PR Review Assistant: {PR Title}

## PR基本情報（最小限）
- **PR**：#{pr_number} - [{owner}/{repo}](https://github.com/{owner}/{repo}/pull/{pr_number})
- **作成者**：@{author}
- **変更規模**：{files_count}ファイル、+{total_additions}/-{total_deletions}行
- **調査日時**：{調査実行日時}
- **調査結果ファイル**：`PR_Review_{pr_number}.md`

---

## 目的

このPRの目的と意図を簡潔に説明します。

{PRのタイトルと説明から抽出した目的・意図}

---

## 全体像

このPRで行われた変更の概要を説明します。

### 変更の概要
{変更の全体像を簡潔に説明}

### 主要な変更領域
{主要な変更領域を箇条書きで列挙}

---

## 修正前後の挙動比較

| 機能/修正項目 | 修正前 (Before) | 修正後 (After) | 備考 |
| :--- | :--- | :--- | :--- |
| {項目名} | {修正前の挙動・状態} | {修正後の挙動・状態} | {補足情報} |

---

## 懸念点とレビュー観点

### 高優先度（必須確認）
{セキュリティ、重大なバグ、パフォーマンスへの大きな影響など}

### 中優先度（推奨確認）
{コード品質、アーキテクチャ、テストなど}

### 低優先度（任意確認）
{ドキュメント、UI/UXの微調整など}

### レビュー観点チェックリスト

#### 機能性
- [ ] 要件が正しく実装されているか
- [ ] エッジケースが考慮されているか
- [ ] エラーハンドリングが適切か

#### コード品質
- [ ] 可読性は十分か
- [ ] 命名規則は適切か
- [ ] コードの重複はないか

#### アーキテクチャ
- [ ] 設計パターンは適切か
- [ ] 関心の分離ができているか
- [ ] 依存関係は適切か

#### パフォーマンス
- [ ] パフォーマンスへの影響はないか
- [ ] メモリ使用量は適切か

#### セキュリティ
- [ ] セキュリティ脆弱性はないか
- [ ] 認証・認可は適切か

#### テスト
- [ ] テストカバレッジは十分か
- [ ] テストの品質は適切か

---

## 詳細情報

### ファイル構造
{ファイル構造のMermaid図}

### UML図
{クラス図、シーケンス図などのMermaid図}

### 処理フロー図
{処理フローのMermaid図}

### 変更統計

| ファイル数 | 追加行 | 削除行 |
|----------|--------|--------|
| {files_count} | +{total_additions} | -{total_deletions} |

### ファイル別変更詳細
{各ファイルの変更詳細}

### コミット履歴
{コミット履歴を時系列で整理}

```

## 重要：Mermaid図式のフォーマット

**Mermaid図式は、Markdownレンダラーで正しく表示されるよう、以下を厳守してください：**

1. **コードブロックの言語指定**：必ず ` ```mermaid ` で開始
2. **構文エラーの回避**：
   - ノード名に特殊文字（`<>[]{}()`等）を含める場合は引用符で囲む
   - 矢印の記法（`-->`、`->>` 等）を正しく使用
   - インデントを揃える
3. **図の種類ごとの宣言**：`classDiagram`、`sequenceDiagram`、`flowchart TD`、`stateDiagram-v2` を正しく記述
4. **出力前の検証**：図が正しくレンダリングされることを確認してから出力
